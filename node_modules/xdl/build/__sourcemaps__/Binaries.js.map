{"version":3,"sources":["Binaries.js"],"names":["async","name","await","sourceBashLoginScriptsAsync","_hasbinAsync","let","ignoreBundledBinaries","UserSettings","getAsync","includes","binariesPath","path","join","getBinariesPath","_prependToPath","addToPathAsync","hasSourcedBashLoginScripts","process","platform","Config","developerTool","userSettingsPATH","_expoRCFileExists","result","spawnAsync","env","PATH","stderr","Logger","global","warn","stdout","e","shellName","SHELL","Error","test","ERROR_MESSAGE","regexResult","match","length","setAsync","pathFile","dotExpoHomeDirectory","fs","promise","writeFile","writePathToUserSettingsAsync","isXcodeInstalled","OSX_SOURCE_PATH","__dirname","Promise","resolve","reject","hasbin","ErrorCode","PLATFORM_NOT_SUPPORTED","statSync","isFile","newPath","currentPath","delimiter","_isDirectory","dir","isDirectory"],"mappings":"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","file":"../Binaries.js","sourcesContent":["/**\n * @flow\n */\n\nimport 'instapromise';\n\nimport fs from 'fs';\nimport hasbin from 'hasbin';\nimport spawnAsync from '@exponent/spawn-async';\nimport path from 'path';\n\nimport Config from './Config';\nimport ErrorCode from './ErrorCode';\nimport Logger from './Logger';\nimport UserSettings from './UserSettings';\nimport XDLError from './XDLError';\n\nlet hasSourcedBashLoginScripts = false;\n\nexport const OSX_SOURCE_PATH = path.join(__dirname, '..', 'binaries', 'osx');\nconst ERROR_MESSAGE = '\\nPlease run `npm install -g exp && exp path`';\n\nfunction _hasbinAsync(name) {\n  return new Promise((resolve, reject) => {\n    hasbin(name, result => {\n      resolve(result);\n    });\n  });\n}\n\nexport function getBinariesPath(): string {\n  if (process.platform === 'darwin') {\n    return path.join(__dirname, '..', 'binaries', 'osx');\n  } else if (process.platform === 'win32') {\n    return path.join(__dirname, '..', 'binaries', 'windows');\n  } else if (process.platform === 'linux') {\n    return path.join(__dirname, '..', 'binaries', 'linux');\n  } else {\n    throw new XDLError(\n      ErrorCode.PLATFORM_NOT_SUPPORTED,\n      'Platform not supported.'\n    );\n  }\n}\n\nexport async function addToPathAsync(name: string) {\n  await sourceBashLoginScriptsAsync();\n\n  if (await _hasbinAsync(name)) {\n    return;\n  }\n\n  // Users can set {ignoreBundledBinaries: [\"watchman\"]} to tell us to never use our version\n  let ignoreBundledBinaries = await UserSettings.getAsync(\n    'ignoreBundledBinaries',\n    []\n  );\n  if (ignoreBundledBinaries.includes(name)) {\n    return;\n  }\n\n  let binariesPath = path.join(getBinariesPath(), name);\n  _prependToPath(binariesPath);\n}\n\nfunction _expoRCFileExists() {\n  try {\n    return fs\n      .statSync(path.join(UserSettings.dotExpoHomeDirectory(), 'bashrc'))\n      .isFile();\n  } catch (e) {\n    return false;\n  }\n}\n\nfunction _prependToPath(newPath) {\n  let currentPath = process.env.PATH ? process.env.PATH : '';\n  if (currentPath.length > 0) {\n    let delimiter = process.platform === 'win32' ? ';' : ':';\n    currentPath = `${delimiter}${currentPath}`;\n  }\n\n  process.env.PATH = `${newPath}${currentPath}`;\n}\n\nexport async function sourceBashLoginScriptsAsync() {\n  if (hasSourcedBashLoginScripts || process.platform === 'win32') {\n    return;\n  }\n\n  if (Config.developerTool !== 'xde') {\n    return;\n  }\n\n  hasSourcedBashLoginScripts = true;\n\n  let userSettingsPATH = await UserSettings.getAsync('PATH', null);\n\n  if (userSettingsPATH) {\n    _prependToPath(userSettingsPATH);\n  } else if (_expoRCFileExists()) {\n    try {\n      // User has a ~/.expo/bashrc. Run that and grab PATH.\n      let result = await spawnAsync(\n        path.join(getBinariesPath(), `get-path-bash`),\n        {\n          env: {\n            PATH: '',\n          },\n        }\n      );\n\n      if (result.stderr) {\n        Logger.global.warn(\n          `Error sourcing ~/.expo/bashrc script: ${result.stderr}`\n        );\n      }\n\n      if (result.stdout) {\n        _prependToPath(result.stdout);\n      }\n    } catch (e) {\n      Logger.global.warn(`Error sourcing ~/.expo/bashrc script: ${e.stderr}`);\n    }\n  } else {\n    try {\n      // No ~/.expo/bashrc file found. Run `env` in process.env.SHELL.\n      const shellName = process.env.SHELL;\n      if (!shellName) {\n        throw new Error('This command requires being run within a shell.');\n      }\n\n      let result;\n      if (/t?csh$/.test(shellName)) {\n        // csh\n        result = await spawnAsync(shellName, ['-d', '-c', 'env']);\n      } else if (/zsh$/.test(shellName)) {\n        // zsh\n        result = await spawnAsync(shellName, ['-l', '-c', 'env']);\n      } else {\n        // bash, fish\n        result = await spawnAsync(shellName, ['-l', '-c', 'env']);\n      }\n\n      if (result.stderr) {\n        Logger.global.warn(\n          `Error sourcing shell startup scripts: ${result.stderr}.${ERROR_MESSAGE}`\n        );\n      }\n\n      if (result.stdout) {\n        let regexResult = result.stdout.match(/(^|\\n)PATH=(.+)/);\n\n        if (regexResult.length >= 3) {\n          _prependToPath(regexResult[2]);\n        } else {\n          Logger.global.warn(\n            `Error parsing shell startup scripts output: ${result.stderr}.${ERROR_MESSAGE}`\n          );\n        }\n      }\n    } catch (e) {\n      Logger.global.warn(\n        `Error sourcing shell startup scripts: ${e.stderr}.${ERROR_MESSAGE}`\n      );\n    }\n  }\n}\n\nexport async function writePathToUserSettingsAsync() {\n  await UserSettings.setAsync('PATH', process.env.PATH);\n\n  // Used in detach app\n  let pathFile = path.join(UserSettings.dotExpoHomeDirectory(), 'PATH');\n  await fs.promise.writeFile(pathFile, process.env.PATH);\n}\n\nfunction _isDirectory(dir) {\n  try {\n    if (fs.statSync(dir).isDirectory()) {\n      return true;\n    }\n\n    return false;\n  } catch (e) {\n    return false;\n  }\n}\n\nexport function isXcodeInstalled() {\n  return _isDirectory('/Applications/Xcode.app/');\n}\n"],"sourceRoot":"/xdl/src"}