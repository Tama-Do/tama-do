{"version":3,"sources":["detach/IosShellApp.js"],"names":["async","args","iosDir","privateConfigFile","spawnAsyncThrowError","path","join","configureShellAppSecretsAsync","entitlementsFilePath","buildConfiguration","manifest","result","modifyIOSPropertyListAsync","config","let","iCloudKeys","forEach","key","hasOwnProperty","ios","associatedDomains","configureStandaloneIOSEntitlementsAsync","configFilePath","privateConfig","bundleIdentifier","await","infoPlist","extraConfig","CFBundleIdentifier","Error","CFBundleName","name","linkingSchemes","scheme","facebookScheme","startsWith","push","googleSignIn","reservedClientId","CFBundleURLTypes","CFBundleURLSchemes","CFBundleURLName","usesNonExemptEncryption","ITSAppUsesNonExemptEncryption","googleMapsApiKey","GMSApiKey","EXClientVersion","CFBundleVersion","version","buildNumber","CFBundleShortVersionString","Fabric","APIKey","fabric","apiKey","DEFAULT_FABRIC_KEY","Kits","KitInfo","KitName","branch","branch_key","live","permissionsAppName","indexOf","replace","UIDeviceFamily","supportsTablet","isTabletOnly","configureStandaloneIOSInfoPlistAsync","manifestUrl","shellConfig","isShell","permissions","isDetached","isManifestVerificationBypassed","isRemoteJSEnabled","console","log","configureStandaloneIOSShellPlistAsync","validateConfigArguments","privateConfigContents","fs","promise","readFile","JSON","parse","url","configuration","UILaunchStoryboardName","configurePropertyListsAsync","bundleUrl","writeFile","stringify","saveUrlToPathAsync","preloadManifestAndBundleAsync","restoreOriginals","cleanIOSPropertyListBackupAsync","cleanPropertyListBackupsAsync","iOSRootPath","relativeBuildDestination","action","verbose","type","buildCmd","buildDest","pathToApp","stdio","cwd","shell","artifactLocation","buildAsync","validateArgs","sdkVersion","output","getManifestAsync","archivePath","configureIOSIconsAsync","archiveName","spawnAsync","createIOSShellAppAsync","cmdArgs","bundleIdentifierFromManifest","warn"],"mappings":"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","file":"../../detach/IosShellApp.js","sourcesContent":["// Copyright 2015-present 650 Industries. All rights reserved.\n\n'use strict';\n\nimport 'instapromise';\n\nimport fs from 'fs';\nimport path from 'path';\nimport {\n  getManifestAsync,\n  saveUrlToPathAsync,\n  spawnAsync,\n  spawnAsyncThrowError,\n  modifyIOSPropertyListAsync,\n  cleanIOSPropertyListBackupAsync,\n  configureIOSIconsAsync,\n} from './ExponentTools';\n\n// TODO: move this somewhere else. this is duplicated in universe/exponent/template-files/keys,\n// but xdl doesn't have access to that.\nconst DEFAULT_FABRIC_KEY = '81130e95ea13cd7ed9a4f455e96214902c721c99';\n\nfunction validateConfigArguments(manifest, cmdArgs, configFilePath) {\n  if (!configFilePath) {\n    throw new Error('No path to config files provided');\n  }\n  let bundleIdentifierFromManifest = manifest.ios\n    ? manifest.ios.bundleIdentifier\n    : null;\n  if (!bundleIdentifierFromManifest && !cmdArgs.bundleIdentifier) {\n    throw new Error(\n      'No bundle identifier found in either the manifest or argv'\n    );\n  }\n  if (!manifest.name) {\n    throw new Error('Manifest does not have a name');\n  }\n\n  if (!cmdArgs.privateConfigFile) {\n    console.warn('Warning: No config file specified.');\n  }\n  return true;\n}\n\n/**\n * Writes Fabric config to private-shell-app-config.json if necessary. Used by\n * generate-dynamic-macros when building.\n */\nasync function configureShellAppSecretsAsync(args, iosDir) {\n  if (!args.privateConfigFile) {\n    return;\n  }\n\n  spawnAsyncThrowError('/bin/cp', [\n    args.privateConfigFile,\n    path.join(iosDir, 'private-shell-app-config.json'),\n  ]);\n}\n\n/**\n * Configure a standalone entitlements file.\n * @param entitlementsFilePath Path to directory containing entitlements file\n * @param buildConfiguration Debug or Release\n * @param manifest The app manifest\n */\nasync function configureStandaloneIOSEntitlementsAsync(\n  entitlementsFilePath,\n  buildConfiguration,\n  manifest\n) {\n  const result = modifyIOSPropertyListAsync(\n    entitlementsFilePath,\n    'Exponent.entitlements',\n    config => {\n      // push notif entitlement changes based on build configuration\n      config['aps-environment'] = buildConfiguration === 'Release'\n        ? 'production'\n        : 'development';\n\n      // remove iCloud-specific entitlements and allow the developer to configure\n      // this themselves.\n      let iCloudKeys = [\n        'com.apple.developer.icloud-container-identifiers',\n        'com.apple.developer.icloud-services',\n        'com.apple.developer.ubiquity-container-identifiers',\n        'com.apple.developer.ubiquity-kvstore-identifier',\n      ];\n      iCloudKeys.forEach(key => {\n        if (config.hasOwnProperty(key)) {\n          delete config[key];\n        }\n      });\n\n      // Add app associated domains remove exp-specific ones.\n      if (manifest.ios && manifest.ios.associatedDomains) {\n        config['com.apple.developer.associated-domains'] =\n          manifest.ios.associatedDomains;\n      } else if (\n        config.hasOwnProperty('com.apple.developer.associated-domains')\n      ) {\n        delete config['com.apple.developer.associated-domains'];\n      }\n\n      return config;\n    }\n  );\n  return result;\n}\n\n/**\n * Configure an iOS Info.plist for a standalone app given its exponent configuration.\n * @param configFilePath Path to directory containing Info.plist\n * @param manifest the app's manifest\n * @param privateConfig optional config with the app's private keys\n * @param bundleIdentifier optional bundle id if the manifest doesn't contain one already\n */\nasync function configureStandaloneIOSInfoPlistAsync(\n  configFilePath,\n  manifest,\n  privateConfig = null,\n  bundleIdentifier = null\n) {\n  let result = await modifyIOSPropertyListAsync(\n    configFilePath,\n    'Info',\n    config => {\n      // make sure this happens first:\n      // apply any custom information from ios.infoPlist prior to all other exponent config\n      if (manifest.ios && manifest.ios.infoPlist) {\n        let extraConfig = manifest.ios.infoPlist;\n        for (let key in extraConfig) {\n          if (extraConfig.hasOwnProperty(key)) {\n            config[key] = extraConfig[key];\n          }\n        }\n      }\n\n      // bundle id\n      config.CFBundleIdentifier = manifest.ios && manifest.ios.bundleIdentifier\n        ? manifest.ios.bundleIdentifier\n        : bundleIdentifier;\n      if (!config.CFBundleIdentifier) {\n        throw new Error(\n          `Cannot configure an iOS app with no bundle identifier.`\n        );\n      }\n\n      // app name\n      config.CFBundleName = manifest.name;\n\n      // determine app linking schemes\n      let linkingSchemes = manifest.scheme ? [manifest.scheme] : [];\n      if (manifest.facebookScheme && manifest.facebookScheme.startsWith('fb')) {\n        linkingSchemes.push(manifest.facebookScheme);\n      }\n      if (\n        privateConfig &&\n        privateConfig.googleSignIn &&\n        privateConfig.googleSignIn.reservedClientId\n      ) {\n        linkingSchemes.push(privateConfig.googleSignIn.reservedClientId);\n      }\n\n      // remove exp scheme, add app scheme(s)\n      config.CFBundleURLTypes = [\n        {\n          CFBundleURLSchemes: linkingSchemes,\n        },\n        {\n          // Add the generic oauth redirect, it's important that it has the name\n          // 'OAuthRedirect' so we can find it in app code.\n          CFBundleURLName: 'OAuthRedirect',\n          CFBundleURLSchemes: [config.CFBundleIdentifier],\n        },\n      ];\n\n      // set ITSAppUsesNonExemptEncryption to let people skip manually\n      // entering it in iTunes Connect\n      if (\n        privateConfig &&\n        privateConfig.hasOwnProperty('usesNonExemptEncryption') &&\n        privateConfig.usesNonExemptEncryption === false\n      ) {\n        config.ITSAppUsesNonExemptEncryption = false;\n      }\n\n      // google maps api key\n      if (privateConfig && privateConfig.googleMapsApiKey) {\n        config.GMSApiKey = privateConfig.googleMapsApiKey;\n      }\n\n      // permanently save the exponent client version at time of configuration\n      config.EXClientVersion = config.CFBundleVersion;\n\n      // use version from manifest\n      let version = manifest.version ? manifest.version : '0.0.0';\n      let buildNumber = manifest.ios && manifest.ios.buildNumber\n        ? manifest.ios.buildNumber\n        : '1';\n      config.CFBundleShortVersionString = version;\n      config.CFBundleVersion = buildNumber;\n\n      config.Fabric = {\n        APIKey: (privateConfig &&\n          privateConfig.fabric &&\n          privateConfig.fabric.apiKey) ||\n          DEFAULT_FABRIC_KEY,\n        Kits: [\n          {\n            KitInfo: {},\n            KitName: 'Crashlytics',\n          },\n        ],\n      };\n\n      if (privateConfig && privateConfig.branch) {\n        config.branch_key = {\n          live: privateConfig.branch.apiKey,\n        };\n      }\n\n      let permissionsAppName = manifest.name ? manifest.name : 'this app';\n      for (let key in config) {\n        if (\n          config.hasOwnProperty(key) && key.indexOf('UsageDescription') !== -1\n        ) {\n          config[key] = config[key].replace(\n            'Expo experiences',\n            permissionsAppName\n          );\n        }\n      }\n\n      // 1 is iPhone, 2 is iPad\n      config.UIDeviceFamily = manifest.ios && manifest.ios.supportsTablet\n        ? [1, 2]\n        : [1];\n\n      // allow iPad-only\n      if (manifest.ios && manifest.ios.isTabletOnly) {\n        config.UIDeviceFamily = [2];\n      }\n\n      return config;\n    }\n  );\n  return result;\n}\n\n/**\n * Configure EXShell.plist for a standalone app given its exponent configuration.\n * @param configFilePath Path to Info.plist\n * @param manifest the app's manifest\n * @param manifestUrl the app's manifest url\n */\nasync function configureStandaloneIOSShellPlistAsync(\n  configFilePath,\n  manifest,\n  manifestUrl\n) {\n  await modifyIOSPropertyListAsync(configFilePath, 'EXShell', shellConfig => {\n    shellConfig.isShell = true;\n    shellConfig.manifestUrl = manifestUrl;\n    if (manifest.ios && manifest.ios.permissions) {\n      shellConfig.permissions = manifest.ios.permissions;\n    }\n    if (manifest.isDetached) {\n      // disable manifest verification on detached apps until\n      // the developer adds the correct entitlements to their bundle id.\n      shellConfig.isManifestVerificationBypassed = true;\n    }\n    if (manifest.ios && manifest.ios.hasOwnProperty('isRemoteJSEnabled')) {\n      // enable/disable code push if the developer provided specific behavior\n      shellConfig.isRemoteJSEnabled = manifest.ios.isRemoteJSEnabled;\n    }\n\n    console.log('Using shell config:', shellConfig);\n    return shellConfig;\n  });\n}\n\nasync function configurePropertyListsAsync(manifest, args, configFilePath) {\n  // make sure we have all the required info\n  validateConfigArguments(manifest, args, configFilePath);\n  console.log(`Modifying config files under ${configFilePath}...`);\n\n  let { privateConfigFile } = args;\n\n  let privateConfig;\n  if (privateConfigFile) {\n    let privateConfigContents = await fs.promise.readFile(\n      privateConfigFile,\n      'utf8'\n    );\n    privateConfig = JSON.parse(privateConfigContents);\n  }\n\n  // generate new shell config\n  await configureStandaloneIOSShellPlistAsync(\n    configFilePath,\n    manifest,\n    args.url\n  );\n\n  // entitlements changes\n  await configureStandaloneIOSEntitlementsAsync(\n    configFilePath,\n    args.configuration,\n    manifest\n  );\n\n  // Info.plist changes specific to turtle\n  await modifyIOSPropertyListAsync(configFilePath, 'Info', config => {\n    // use shell-specific launch screen\n    config.UILaunchStoryboardName = 'LaunchScreenShell';\n    return config;\n  });\n\n  // common standalone Info.plist config changes\n  await configureStandaloneIOSInfoPlistAsync(\n    configFilePath,\n    manifest,\n    privateConfig,\n    args.bundleIdentifier\n  );\n}\n\n/**\n * Write the manifest and JS bundle to the iOS NSBundle.\n */\nasync function preloadManifestAndBundleAsync(manifest, args, configFilePath) {\n  let bundleUrl = manifest.bundleUrl;\n  await fs.promise.writeFile(\n    `${configFilePath}/shell-app-manifest.json`,\n    JSON.stringify(manifest)\n  );\n  await saveUrlToPathAsync(bundleUrl, `${configFilePath}/shell-app.bundle`);\n  return;\n}\n\nasync function cleanPropertyListBackupsAsync(configFilePath, restoreOriginals) {\n  console.log('Cleaning up...');\n  await cleanIOSPropertyListBackupAsync(\n    configFilePath,\n    'EXShell',\n    restoreOriginals\n  );\n  await cleanIOSPropertyListBackupAsync(\n    configFilePath,\n    'Exponent.entitlements',\n    restoreOriginals\n  );\n  await cleanIOSPropertyListBackupAsync(\n    configFilePath,\n    'Info',\n    restoreOriginals\n  );\n}\n\n/**\n *  Build the iOS binary from source.\n *  @return the path to the resulting .app\n */\nasync function buildAsync(args, iOSRootPath, relativeBuildDestination) {\n  let { action, configuration, verbose, type } = args;\n\n  let buildCmd, buildDest, pathToApp;\n  if (type === 'simulator') {\n    buildDest = `${iOSRootPath}/${relativeBuildDestination}-simulator`;\n    buildCmd = `xcodebuild -workspace Exponent.xcworkspace -scheme Exponent -sdk iphonesimulator -configuration ${configuration} -derivedDataPath ${buildDest} CODE_SIGN_IDENTITY=\"\" CODE_SIGNING_REQUIRED=NO SKIP_INSTALL=NO ARCHS=\"i386 x86_64\" ONLY_ACTIVE_ARCH=NO | xcpretty`;\n    pathToApp = `${buildDest}/Build/Products/${configuration}-iphonesimulator/Exponent.app`;\n  } else if (type === 'archive') {\n    buildDest = `${iOSRootPath}/${relativeBuildDestination}-archive`;\n    buildCmd = `xcodebuild -workspace Exponent.xcworkspace -scheme Exponent archive -configuration ${configuration} -derivedDataPath ${buildDest} -archivePath ${buildDest}/Exponent.xcarchive CODE_SIGN_IDENTITY=\"\" CODE_SIGNING_REQUIRED=NO SKIP_INSTALL=NO | xcpretty`;\n    pathToApp = `${buildDest}/Exponent.xcarchive/Products/Applications/Exponent.app`;\n  }\n\n  if (buildCmd) {\n    console.log(\n      `Building shell app under ${iOSRootPath}/${relativeBuildDestination}`\n    );\n    console.log(`  (action: ${action}, configuration: ${configuration})...`);\n    console.log(buildCmd);\n    await spawnAsyncThrowError(buildCmd, null, {\n      // only stderr\n      stdio: verbose ? 'inherit' : ['ignore', 'ignore', 'inherit'],\n      cwd: iOSRootPath,\n      shell: true,\n    });\n\n    let artifactLocation = `${iOSRootPath}/../shellAppBase-builds/${type}/${configuration}/`;\n    await spawnAsyncThrowError('/bin/rm', ['-rf', artifactLocation]);\n    await spawnAsyncThrowError('/bin/mkdir', ['-p', artifactLocation]);\n\n    if (type === 'archive') {\n      await spawnAsyncThrowError('/bin/cp', [\n        '-R',\n        `${buildDest}/Exponent.xcarchive`,\n        artifactLocation,\n      ]);\n    } else if (type === 'simulator') {\n      await spawnAsyncThrowError('/bin/cp', [\n        '-R',\n        pathToApp,\n        artifactLocation,\n      ]);\n    }\n  }\n  return pathToApp;\n}\n\nfunction validateArgs(args) {\n  args.type = args.type || 'archive';\n  args.configuration = args.configuration || 'Release';\n  args.verbose = args.verbose || false;\n\n  switch (args.type) {\n    case 'simulator': {\n      if (args.configuration !== 'Debug' && args.configuration !== 'Release') {\n        throw new Error(\n          `Unsupported build configuration ${args.configuration}`\n        );\n      }\n      break;\n    }\n    case 'archive': {\n      if (args.configuration !== 'Release') {\n        throw new Error(\n          'Release is the only supported configuration when archiving'\n        );\n      }\n      break;\n    }\n    default: {\n      throw new Error(`Unsupported build type ${args.type}`);\n    }\n  }\n\n  switch (args.action) {\n    case 'configure': {\n      if (!args.url) {\n        throw new Error('Must run with `--url MANIFEST_URL`');\n      }\n      if (!args.sdkVersion) {\n        throw new Error('Must run with `--sdkVersion SDK_VERSION`');\n      }\n      if (!args.archivePath) {\n        throw new Error(\n          'Need to provide --archivePath <path to existing archive for configuration>'\n        );\n      }\n      break;\n    }\n    case 'build': {\n      break;\n    }\n    default: {\n      throw new Error(`Unsupported build action ${args.action}`);\n    }\n  }\n\n  return args;\n}\n\n/**\n*  @param url manifest url for shell experience\n*  @param sdkVersion sdk to use when requesting the manifest\n*  @param action\n*    build - build a binary\n*    configure - don't build anything, just configure the files in an existing .app bundle\n*  @param type simulator or archive, for action == build\n*  @param configuration Debug or Release, for type == simulator (default Release)\n*  @param archivePath path to existing bundle, for action == configure\n*  @param privateConfigFile path to a private config file containing, e.g., private api keys\n*  @param bundleIdentifier iOS CFBundleIdentifier to use in the bundle config\n*  @param verbose show all xcodebuild output (default false)\n*/\nasync function createIOSShellAppAsync(args) {\n  let configFilePath;\n  args = validateArgs(args);\n\n  if (args.action !== 'configure') {\n    // build the app before configuring\n    await configureShellAppSecretsAsync(args, '../ios');\n    configFilePath = await buildAsync(args, '../ios', '../shellAppBase');\n  } else {\n    let { url, sdkVersion, output, type } = args;\n\n    // fetch manifest\n    let manifest = await getManifestAsync(url, {\n      'Exponent-SDK-Version': sdkVersion,\n      'Exponent-Platform': 'ios',\n    });\n\n    // action === 'configure'\n    configFilePath = args.archivePath;\n    // just configure, don't build anything\n    await configurePropertyListsAsync(manifest, args, configFilePath);\n    await configureIOSIconsAsync(manifest, configFilePath);\n    await preloadManifestAndBundleAsync(manifest, args, configFilePath);\n    await cleanPropertyListBackupsAsync(configFilePath, false);\n\n    let archiveName = manifest.name.replace(/\\s+/g, '');\n    if (type === 'simulator') {\n      await spawnAsync(\n        `mv Exponent.app ${archiveName}.app && tar cvf ${output} ${archiveName}.app`,\n        null,\n        {\n          stdio: 'inherit',\n          cwd: `${configFilePath}/..`,\n          shell: true,\n        }\n      );\n    } else if (type === 'archive') {\n      await spawnAsync('/bin/mv', ['Exponent.xcarchive', output], {\n        stdio: 'inherit',\n        cwd: `${configFilePath}/../../../..`,\n      });\n    }\n  }\n\n  return;\n}\n\nexport {\n  createIOSShellAppAsync,\n  configureStandaloneIOSInfoPlistAsync,\n  configureStandaloneIOSShellPlistAsync,\n};\n"],"sourceRoot":"/xdl/src"}