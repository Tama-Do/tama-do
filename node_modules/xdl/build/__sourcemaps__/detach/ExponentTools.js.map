{"version":3,"sources":["detach/ExponentTools.js"],"names":["async","url","headers","let","requestOptions","replace","response","await","request","promise","responseBody","body","console","log","manifest","JSON","parse","getManifestAsync","args","length","spawnAsyncQuiet","stdio","cwd","process","spawnAsyncThrowError","e","error","message","spawnAsync","filename","transform","fileString","fs","readFile","newFileString","writeFile","transformFileContentsAsync","plistPath","plistName","plistFilename","indexOf","configPlistName","path","join","configFilename","configContents","config","stringify","modifyIOSPropertyListAsync","restoreOriginal","cleanIOSPropertyListBackupAsync","dirname","basename","platform","warn","childProcess","dimensions","components","stdout","split","map","c","parseInt","filter","n","isNaN","_","getImageDimensionsAsync","destinationIconPath","projectRoot","defaultIconFilename","iconUrl","saveUrlToPathAsync","icon","saveIconToPathAsync","iconSizes","forEach","iconSize","iconResolutions","iconResolution","iconQualifier","getAppleIconQualifier","iconKey","rawIconFilename","usesDefault","ios","hasOwnProperty","iconFilename","iconSizePx","dims","Error","configureIOSIconsAsync","parseSdkMajorVersion","expSdkVersion","sdkMajorVersion","versionComponents","number","Promise","resolve","reject","stream","createWriteStream","on","getFilesizeInBytes","pipe","pathOrURL","outPath","localPath","existsSync","createReadStream","stats","statSync","fileSizeInBytes"],"mappings":"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","file":"../../detach/ExponentTools.js","sourcesContent":["// Copyright 2015-present 650 Industries. All rights reserved.\n\n'use strict';\n\nimport fs from 'fs';\nimport path from 'path';\nimport request from 'request';\nimport spawnAsyncQuiet from '@exponent/spawn-async';\n\nfunction parseSdkMajorVersion(expSdkVersion) {\n  let sdkMajorVersion = 0;\n  try {\n    let versionComponents = expSdkVersion\n      .split('.')\n      .map(number => parseInt(number, 10));\n    sdkMajorVersion = versionComponents[0];\n  } catch (_) {}\n  return sdkMajorVersion;\n}\n\nfunction saveUrlToPathAsync(url, path) {\n  return new Promise(function(resolve, reject) {\n    let stream = fs.createWriteStream(path);\n    stream.on('close', () => {\n      if (getFilesizeInBytes(path) < 10) {\n        throw new Error(`{filename} is too small`);\n      }\n      resolve();\n    });\n    stream.on('error', reject);\n    request(url).pipe(stream);\n  });\n}\n\nfunction saveIconToPathAsync(projectRoot, pathOrURL, outPath) {\n  const localPath = path.resolve(projectRoot, pathOrURL);\n  return new Promise(function(resolve, reject) {\n    let stream = fs.createWriteStream(outPath);\n    stream.on('close', () => {\n      if (getFilesizeInBytes(outPath) < 10) {\n        throw new Error(`{filename} is too small`);\n      }\n      resolve();\n    });\n    stream.on('error', reject);\n    if (fs.existsSync(localPath)) {\n      fs.createReadStream(localPath).pipe(stream);\n    } else {\n      request(pathOrURL).pipe(stream);\n    }\n  });\n}\n\nfunction getFilesizeInBytes(path) {\n  let stats = fs.statSync(path);\n  let fileSizeInBytes = stats['size'];\n  return fileSizeInBytes;\n}\n\nasync function getManifestAsync(url, headers) {\n  let requestOptions = {\n    url: url.replace('exp://', 'http://') + '/index.exp',\n    headers,\n  };\n\n  let response = await request.promise(requestOptions);\n  let responseBody = response.body;\n  console.log('Using manifest:', responseBody);\n  let manifest = JSON.parse(responseBody);\n\n  return manifest;\n}\n\nasync function spawnAsyncThrowError(...args) {\n  if (args.length === 2) {\n    return spawnAsyncQuiet(args[0], args[1], {\n      stdio: 'inherit',\n      cwd: process.cwd(),\n    });\n  } else {\n    return spawnAsyncQuiet(...args);\n  }\n}\n\nasync function spawnAsync(...args) {\n  try {\n    return await spawnAsyncThrowError(...args);\n  } catch (e) {\n    console.error(e.message);\n  }\n}\n\nasync function transformFileContentsAsync(filename, transform) {\n  let fileString = await fs.promise.readFile(filename, 'utf8');\n  let newFileString = transform(fileString);\n  if (newFileString !== null) {\n    await fs.promise.writeFile(filename, newFileString);\n  }\n  return;\n}\n\n/**\n *  @param plistName base filename of property list. if no extension, assumes .plist\n */\nasync function modifyIOSPropertyListAsync(plistPath, plistName, transform) {\n  let plistFilename;\n  if (plistName.indexOf('.') !== -1) {\n    plistFilename = plistName;\n  } else {\n    plistFilename = `${plistName}.plist`;\n  }\n  let configPlistName = path.join(plistPath, plistFilename);\n  let configFilename = path.join(plistPath, `${plistName}.json`);\n\n  // grab original plist as json object\n  await spawnAsyncThrowError('plutil', [\n    '-convert',\n    'json',\n    configPlistName,\n    '-o',\n    configFilename,\n  ]);\n  let configContents = await fs.promise.readFile(configFilename, 'utf8');\n  let config;\n\n  try {\n    config = JSON.parse(configContents);\n  } catch (e) {\n    console.log(`Error parsing ${configFilename}`, e);\n    console.log('The erroneous file contents was:', configContents);\n    config = {};\n  }\n\n  // apply transformation\n  config = transform(config);\n\n  // back up old plist and swap in modified one\n  await spawnAsyncThrowError('/bin/cp', [\n    configPlistName,\n    `${configPlistName}.bak`,\n  ]);\n  await fs.promise.writeFile(configFilename, JSON.stringify(config));\n  await spawnAsyncThrowError('plutil', [\n    '-convert',\n    'xml1',\n    configFilename,\n    '-o',\n    configPlistName,\n  ]);\n  return config;\n}\n\nasync function cleanIOSPropertyListBackupAsync(\n  plistPath,\n  plistName,\n  restoreOriginal = true\n) {\n  let plistFilename;\n  if (plistName.indexOf('.') !== -1) {\n    plistFilename = plistName;\n  } else {\n    plistFilename = `${plistName}.plist`;\n  }\n  let configPlistName = path.join(plistPath, plistFilename);\n  let configFilename = path.join(plistPath, `${plistName}.json`);\n\n  if (restoreOriginal) {\n    await spawnAsyncThrowError('/bin/cp', [\n      `${configPlistName}.bak`,\n      configPlistName,\n    ]);\n  }\n\n  await spawnAsyncThrowError('/bin/rm', [`${configPlistName}.bak`]);\n  await spawnAsyncThrowError('/bin/rm', [configFilename]);\n  return;\n}\n\nfunction getAppleIconQualifier(iconSize, iconResolution) {\n  let iconQualifier;\n  if (iconResolution !== 1) {\n    // e.g. \"29x29@3x\"\n    iconQualifier = `${iconSize}x${iconSize}@${iconResolution}x`;\n  } else {\n    iconQualifier = `${iconSize}x${iconSize}`;\n  }\n  if (iconSize === 76 || iconSize === 83.5) {\n    // ipad sizes require ~ipad at the end\n    iconQualifier = `${iconQualifier}~ipad`;\n  }\n  return iconQualifier;\n}\n\n/**\n *  @return array [ width, height ] or nil if that fails for some reason.\n */\nasync function getImageDimensionsAsync(dirname, basename) {\n  if (process.platform !== 'darwin') {\n    console.warn('`sips` utility may or may not work outside of macOS');\n  }\n  let childProcess = await spawnAsyncThrowError(\n    'sips',\n    ['-g', 'pixelWidth', '-g', 'pixelHeight', basename],\n    {\n      cwd: dirname,\n    }\n  );\n  let dimensions;\n  try {\n    // stdout looks something like 'pixelWidth: 1200\\n pixelHeight: 800'\n    const components = childProcess.stdout.split(/(\\s+)/);\n    dimensions = components.map(c => parseInt(c, 10)).filter(n => !isNaN(n));\n  } catch (_) {}\n  return dimensions;\n}\n\n/**\n * Based on keys in the given manifest,\n * ensure that the proper iOS icon images exist -- assuming Info.plist already\n * points at them under CFBundleIcons.CFBundlePrimaryIcon.CFBundleIconFiles.\n *\n * This only works on MacOS (as far as I know) because it uses the sips utility.\n */\nasync function configureIOSIconsAsync(\n  manifest,\n  destinationIconPath,\n  projectRoot\n) {\n  if (process.platform !== 'darwin') {\n    console.warn('`sips` utility may or may not work outside of macOS');\n  }\n  let defaultIconFilename;\n  if (manifest.iconUrl) {\n    defaultIconFilename = 'exp-icon.png';\n    await saveUrlToPathAsync(\n      manifest.iconUrl,\n      `${destinationIconPath}/${defaultIconFilename}`\n    );\n  } else if (projectRoot && manifest.icon) {\n    defaultIconFilename = 'exp-icon.png';\n    await saveIconToPathAsync(\n      projectRoot,\n      manifest.icon,\n      `${destinationIconPath}/${defaultIconFilename}`\n    );\n  }\n\n  let iconSizes = [20, 29, 40, 60, 76, 83.5];\n  iconSizes.forEach(iconSize => {\n    let iconResolutions;\n    if (iconSize === 76) {\n      // iPad has 1x and 2x icons for this size only\n      iconResolutions = [1, 2];\n    } else {\n      iconResolutions = [2, 3];\n    }\n    iconResolutions.forEach(async iconResolution => {\n      let iconQualifier = getAppleIconQualifier(iconSize, iconResolution);\n      // TODO(nikki): Support local paths for these icons\n      let iconKey = `iconUrl${iconQualifier}`;\n      let rawIconFilename;\n      let usesDefault = false;\n      if (manifest.ios && manifest.ios.hasOwnProperty(iconKey)) {\n        // manifest specifies an image just for this size/resolution, use that\n        rawIconFilename = `exp-icon${iconQualifier}.png`;\n        await saveUrlToPathAsync(\n          manifest.ios[iconKey],\n          `${destinationIconPath}/${rawIconFilename}`\n        );\n      } else {\n        // use default manifest.iconUrl\n        usesDefault = true;\n        if (defaultIconFilename) {\n          rawIconFilename = defaultIconFilename;\n        } else {\n          console.warn(\n            `Manifest does not specify ios.${iconKey} nor a default iconUrl. Bundle will use the Expo logo.`\n          );\n          return;\n        }\n      }\n\n      let iconFilename = `AppIcon${iconQualifier}.png`;\n      let iconSizePx = iconSize * iconResolution;\n      await spawnAsyncThrowError('/bin/cp', [rawIconFilename, iconFilename], {\n        stdio: 'inherit',\n        cwd: destinationIconPath,\n      });\n      await spawnAsyncThrowError('sips', ['-Z', iconSizePx, iconFilename], {\n        stdio: ['ignore', 'ignore', 'inherit'], // only stderr\n        cwd: destinationIconPath,\n      });\n\n      // reject non-square icons (because Apple will if we don't)\n      const dims = await getImageDimensionsAsync(\n        destinationIconPath,\n        iconFilename\n      );\n      if (!dims || dims.length < 2 || dims[0] !== dims[1]) {\n        throw new Error(\n          `iOS icons must be square, the dimensions of ${iconFilename} are ${dims}`\n        );\n      }\n\n      if (!usesDefault) {\n        // non-default icon used, clean up the downloaded version\n        await spawnAsyncThrowError('/bin/rm', [\n          path.join(destinationIconPath, rawIconFilename),\n        ]);\n      }\n    });\n  });\n\n  // clean up default icon\n  if (defaultIconFilename) {\n    await spawnAsyncThrowError('/bin/rm', [\n      path.join(destinationIconPath, defaultIconFilename),\n    ]);\n  }\n  return;\n}\n\nexport {\n  parseSdkMajorVersion,\n  saveUrlToPathAsync,\n  saveIconToPathAsync,\n  getManifestAsync,\n  getImageDimensionsAsync,\n  spawnAsyncThrowError,\n  spawnAsync,\n  transformFileContentsAsync,\n  modifyIOSPropertyListAsync,\n  cleanIOSPropertyListBackupAsync,\n  configureIOSIconsAsync,\n};\n"],"sourceRoot":"/xdl/src"}